========================================================================================================================
                              GÃ©nÃ©rer une archive pour votre jeu de batchs
========================================================================================================================

L'objectif est de gÃ©nÃ©rer une archive (un fichier TAR.GZ et un fichier ZIP) pour le jeu de batchs de l'application de
gestion de tickets.

Cette archive contiendra :
=========================

      . le JAR du module ticket-batch
      . les JAR de toutes ses dÃ©pendances
      . les fichiers de configuration (modifiables facilement par l'administrateur)
      . les scripts shell de lancement de chaque batch

Voici comment je vais organiser l'archive :
==========================================

      .le rÃ©pertoire bin contiendra les scripts shell de lancement des batchs
      .le rÃ©pertoire conf contiendra les fichiers de configuration
      .le rÃ©pertoire lib contiendra le JAR du module ticket-batch ainsi que les JAR des dÃ©pendances

                                         ğŸ—„ archive
                                         â”œâ”€â”€ ğŸ— bin
                                         â”‚   â”œâ”€â”€ ğŸ— batch-X.sh
                                         â”‚   â”œâ”€â”€ ğŸ— batch-Y.sh
                                         â”‚   â””â”€â”€ ...
                                         â”œâ”€â”€ ğŸ— conf
                                         â”‚   â”œâ”€â”€ ğŸ— config.properties
                                         â”‚   â”œâ”€â”€ ğŸ— db-X.properties
                                         â”‚   â””â”€â”€ ...
                                         â””â”€â”€ ğŸ— lib
                                             â”œâ”€â”€ ğŸ— ticket-batch-*.jar
                                             â”œâ”€â”€ ğŸ— ticket-business-*.jar
                                             â”œâ”€â”€ ğŸ— ticket-model-*.jar
                                             â”œâ”€â”€ ğŸ— commons-lang3-*.jar
                                             â””â”€â”€ ...

PrÃ©parer le terrain
===================

Pour commencer, je vais crÃ©er l'arborescence suivante pour hÃ©berger les fichiers Ã  inclure dans l'archive :

                                         ğŸ— src/data
                                         â”œâ”€â”€ ğŸ— scripts
                                         â”‚   â”œâ”€â”€ ğŸ— batch-X.sh
                                         â”‚   â”œâ”€â”€ ğŸ— batch-Y.sh
                                         â”‚   â””â”€â”€ ...
                                         â””â”€â”€ ğŸ— conf
                                             â”œâ”€â”€ ğŸ— config.properties  (conf. de l'application)
                                             â”œâ”€â”€ ğŸ— db-X.properties    (conf. de la base de donnÃ©es)
                                             â””â”€â”€ ...

Je ne vous dÃ©taille pas le contenu des ces fichiers, cela ne vous sera pas utile ici.

========================================================================================================================
                                       Configuration du JAR des batchs
========================================================================================================================

Ã‰tant donnÃ© que je vais fournir les JAR des dÃ©pendances Ã  cÃ´tÃ© du JAR du module ticket-batch, je vais ajouter le
classpath au manifest de ce JAR. Ainsi, toutes les classes seront trouvÃ©es automatiquement par la JVM lors de
l'exÃ©cution du JAR.

Pour cela, je complÃ¨te la configuration du plugin maven-jar-plugin :

                              <project>
                                  ...
                                  <build>
                                      <plugins>
                                          <!-- CrÃ©ation du JAR -->
                                          <plugin>
                                              <groupId>org.apache.maven.plugins</groupId>
                                              <artifactId>maven-jar-plugin</artifactId>
                                              <configuration>
                                                  <archive>
                                                      <manifest>
                                                          <mainClass>org.exemple.demo.batch.App</mainClass>
                                                          <addClasspath>true</addClasspath>
                                                          <classpathPrefix></classpathPrefix>
                                                      </manifest>
                                                  </archive>
                                              </configuration>
                                          </plugin>
                                          ...
                                      </plugins>
                                  </build>
                                  ...
                              </project>

========================================================================================================================
                                        Assembler le tout dans une archive
========================================================================================================================

Afin de gÃ©nÃ©rer les fichiers d'archive, je vais utiliser le plugin maven-assembly-plugin.

DÃ©finition de l'assemblage
==========================

La dÃ©finition des assemblages se fait grÃ¢ce Ã  des fichiers XML dans le rÃ©pertoire src/assembly.
Je crÃ©e donc un nouveau fichier src/assembly/archive-deploy.xml :


                  <assembly xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                            xmlns="http://maven.apache.org/ASSEMBLY/2.0.0"
                            xsi:schemaLocation="http://maven.apache.org/ASSEMBLY/2.0.0 http://maven.apache.org/xsd/assembly-2.0.0.xsd">

                      <!-- Identifiant de l'assemblage -->
                      <id>archive-deploy</id>

                      <!-- Les formats d'archive Ã  gÃ©nÃ©rer -->
                      <formats>
                          <format>tar.gz</format>
                          <format>zip</format>
                      </formats>

                      <!-- lib : dÃ©pendances + JAR ticket-batch -->
                      <dependencySets>
                          <dependencySet>
                              <outputDirectory>lib</outputDirectory>
                              <scope>runtime</scope>
                          </dependencySet>
                      </dependencySets>

                      <fileSets>
                          <!-- Scripts shell de lancement -->
                          <fileSet>
                              <directory>src/data/scripts</directory>
                              <outputDirectory>bin</outputDirectory>
                              <!-- Droits UNIX sur les fichiers (-rwx-rx-rx) -->
                              <fileMode>0755</fileMode>
                          </fileSet>

                          <!-- Fichiers de configuration -->
                          <fileSet>
                              <directory>src/data/conf</directory>
                              <outputDirectory>conf</outputDirectory>
                          </fileSet>
                      </fileSets>
                  </assembly>

========================================================================================================================
                Voici quelques explications sur les diffÃ©rents Ã©lÃ©ments contenus dans ce fichier :
========================================================================================================================

      .id : l'identifiant de l'assemblage. Maven va se servir de cet identifiant dans le nom des fichiers gÃ©nÃ©rÃ©s :
      <project.finalName>-<id>.<format>. Ce qui donnerait par exemple : ticket-batch-1.0-SNAPSHOT-archive-deploy.tar.gz.

      .formats : les formats de fichier Ã  gÃ©nÃ©rer. Ici un fichier tar.gz et un fichier zip.

      .dependencySets : ajout d'un ensemble de dÃ©pendances. Ici, j'ajoute toutes les dÃ©pendances de runtime
       (scope runtime et compile) du projet dans le rÃ©pertoire de destination lib.

      .fileSets : ajout d'un ensemble de fichiers. Ici, j'ajoute deux ensembles de fichiers :

                .les scripts de lancement des batchs contenus dans le rÃ©pertoire src/data/scripts, dans le rÃ©pertoire
                  de destination bin. J'y positionne les droits Unix, notamment celui d'exÃ©cution :

                                             <fileMode>0755</fileMode> (-rwxr-x-rx).

                .les fichiers de configuration contenus dans le rÃ©pertoire src/data/conf, dans le rÃ©pertoire de destination conf.

========================================================================================================================
                                CÃ¢bler la gÃ©nÃ©ration des fichiers d'archive
========================================================================================================================

La derniÃ¨re Ã©tape consiste Ã  cÃ¢bler la gÃ©nÃ©ration des fichiers d'archive Ã  la phase package :

                            <project>
                                ...
                                <build>
                                    <plugins>
                                        ...
                                        <!-- CrÃ©ation des archives de dÃ©ploiement -->
                                        <plugin>
                                            <groupId>org.apache.maven.plugins</groupId>
                                            <artifactId>maven-assembly-plugin</artifactId>
                                            <configuration>
                                                <descriptors>
                                                    <descriptor>src/assembly/archive-deploy.xml</descriptor>
                                                </descriptors>
                                            </configuration>
                                            <executions>
                                                <execution>
                                                    <id>assembly-archive-deploy</id>
                                                    <phase>package</phase>
                                                    <goals>
                                                        <goal>single</goal>
                                                    </goals>
                                                </execution>
                                            </executions>
                                        </plugin>
                                    </plugins>
                                </build>
                                ...
                            </project>

Et voilÃ , maintenant, si vous lancez la commande suivante, les fichiers archives de l'assemblage archive-deploy seront
gÃ©nÃ©rÃ©s automatiquement dans le rÃ©pertoire target :

                                                  mvn package

Si vous voulez aller plus loin dans les assemblages, vous pouvez consulter la documentation.

========================================================================================================================
                                                   Conclusion
========================================================================================================================

Nous avons vu deux exemples de personnalisation de la construction et de la gÃ©nÃ©ration de livrables de projet Maven.

Je vous invite Ã  tester cela et faire vos propres expÃ©riementations.

Dans le prochain chapitre, vous verrons qu'il est possible d'utiliser Maven pour gÃ©nÃ©rer un site web pour votre projet.
Ce site va donner des informations gÃ©nÃ©rales sur le projet mais aussi des informations sur ses diffÃ©rents modules, la
documentation, des rapports sur l'exÃ©cution des tests.


========================================================================================================================
validate
=========
Valida si el proyecto es correcto y toda la informaciÃ³n requerida estÃ¡ disponible para la compilaciÃ³n.

initialize
==========
Inicializa el entorno de compilaciÃ³n, por ejemplo, establece propiedades o crea directorios.

generate-sources
================
Genera cÃ³digo fuente para ser procesado en la fase de 'compilaciÃ³n'.

process-sources
================
Procesa el cÃ³digo fuente en caso de que sea necesario aplicar algÃºn filtro.

generate-resources
=================
Genera recursos para ser incluidos en el artefacto.

process-resources
================
Procesa y copia recursos en el directorio de salida ( ${basedir}/target/classes ).

compile
=======
Compila el cÃ³digo fuente del proyecto en el directorio de origen ( ${basedir}/src/main/[java|groovy|...] ) en el
directorio de salida ( ${basedir}/target/classes ).

process-classes
===============
Procesa los archivos .class generados en la fase de compile , por ejemplo, para realizar mejoras de cÃ³digo de bytes.

generate-test-sources
=====================
Genera cÃ³digo fuente de prueba para ser procesado en la fase de test-compile .

process-test-sources
====================
Procesa el cÃ³digo fuente de la prueba en caso de que sea necesario aplicar algÃºn filtro.

generate-test-resources
=======================
Genera recursos para pruebas.

process-test-resources
======================
Procesa y copia recursos de prueba en el directorio de recursos ( ${basedir}/src/main/resources ) en el directorio de
salida de prueba ( ${basedir}/target/test-classes ).

test-compile
============
Compila el cÃ³digo fuente en el directorio de origen de prueba ('$ {basedir} / src / test / [java | groovy | ...]') en el
directorio de salida de prueba ( ${basedir}/target/test-classes ).

process-test-classes
====================
Los procesos prueban los archivos .class generados en la fase de test-compile , por ejemplo, para realizar mejoras de
cÃ³digo de bytes (Maven 2.0.5 y superior).

test
====
Ejecuta pruebas utilizando algÃºn marco de prueba adecuado. Nota: estos casos de prueba no se consideran para el
empaquetado y la implementaciÃ³n.

prepare-package
===============
Realiza los cambios finales y las validaciones antes de que finalmente se cree el paquete.

package
=======
Empaqueta el cÃ³digo compilado y probado con Ã©xito en algÃºn formato distribuible como JAR, WAR, EAR en el directorio de
destino ( ${basedir}/target ).

pre-integration-test
====================
Realiza acciones antes de que se ejecuten las pruebas de integraciÃ³n si requieren aplicar algunos cambios en el entorno
para la aplicaciÃ³n.

integration-test
================
Procesa y posiblemente implementa la aplicaciÃ³n en un entorno donde se pueden ejecutar pruebas de integraciÃ³n.

post-integration-test
=====================
Realiza acciones despuÃ©s de las pruebas de integraciÃ³n, como la limpieza del entorno creado en la fase de
pre-integration-test .

verify
======
Comprueba si un paquete es vÃ¡lido y cumple con los criterios de calidad requeridos.

install
=======
Instala el artefacto en el repositorio local. Cualquier otro proyecto local puede usar este artefacto como una de sus
dependencias despuÃ©s de eso (si su IDE no admite la resoluciÃ³n de dependencias del Ã¡rea de trabajo de todos modos).

deploy
======
Copia el paquete en un repositorio remoto para que estÃ© disponible para otros desarrolladores.
